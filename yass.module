<?php

/**
 * (Hook Prototype)
 *
 * @return array(replicaName => YASS_Replica)
 */
function hook_yass_replicas() {
}

/**
 * (Hook Prototype)
 *
 * Notify of on-going operations
 *
 * @param $event array; keys:
 *  - op: string ('preSync', 'postSync', 'preJoin', 'postJoin')
 *  - replica: YASS_Replica
 *  - master: YASS_Replica
 */
function hook_yass_replica($event) {
}

/**
 * Implementation of hook_init
 */
function yass_init() {
  arms_util_add_classes('yass');
}

/**
 * Implementation of hook_arms_clear
 */
function yass_arms_clear() {
  require_once 'YASS/Engine.php';
  $replicaSpecs = module_invoke_all('yass_replicas');
  foreach ($replicaSpecs as $replicaSpec) {
    YASS_Engine::singleton()->updateReplicaSpec($replicaSpec);
  }
}

/**
 * Implementation of hook_perm
 */
function yass_perm() {
  return array(
    'access all replicas',
  );
}

/**
 * Implementation of hook_drush_command
 */
function yass_drush_command() {
  module_load_include('drush.inc', 'yass');
  $items = array();
  $items['yass-info'] = array(
    'callback' => '_yass_drush_info',
    'description' => 'Print details information about a replica. Params: <replica-name>',
  );
  $items['yass-ls'] = array(
    'callback' => '_yass_drush_ls',
    'description' => 'List available replicas',
  );
  $items['yass-rm'] = array(
    'callback' => '_yass_drush_rm',
    'description' => 'DANGEROUS. Remove a replica. Params: <replica-name>',
  );
  $items['yass-join'] = array(
    'callback' => '_yass_drush_join',
    'description' => 'DANGEROUS. Submit all data from replica to master, adding all records as new items. Params: <replica-name>',
  );
  $items['yass-rejoin'] = array(
    'callback' => '_yass_drush_rejoin',
    'description' => 'DANGEROUS. Submit all data from replica to master, overwriting discrepancies in the master. Params: <replica-name>',
  );
  $items['yass-reset'] = array(
    'callback' => '_yass_drush_reset',
    'description' => 'DANGEROUS. Submit all data from master to replica, overwriting discrepancies in the replica. Params: <replica-name>',
  );
  return $items;
}

/**
 * Implementation of hook_yass_replicas
 *
function yass_yass_replicas() {
  return array(
    'test' => array(
      'name' => 'test',
      'datastore' => 'Memory',
      'syncstore' => 'Memory',
    ),
  );
} // */

/**
 * Implementation of hook_yass_replica
 */
function yass_yass_replica($event) {
  $func = 'on' . strtoupper($event['op']{0}) . substr($event['op'], 1);
  // Allow each replica, data store, and sync store to monitor lifecycle events
  foreach (array($event['replica'], $event['replica']->data, $event['replica']->sync, $event['replica']->mapper, $event['replica']->schema) as $listener) {
    $callback = array($listener, $func);
    if (is_callable($callback)) {
      switch ($func) {
        case 'onChangeId':
          call_user_func($callback, $event['replica'], $event['oldId'], $event['newId']);
          break;
        case 'onBuildFilters':
        case 'onCreateSqlTriggers':
          if (!is_array($result)) { $result = array(); }
          $result = array_merge($result, call_user_func($callback, $event['replica']));
          break;
        case 'onPreJoin':
        case 'onPostJoin':
        case 'onPreRejoin':
        case 'onPostRejoin':
        case 'onPreReset':
        case 'onPostReset':
          call_user_func($callback, $event['replica'], $event['master']);
          break;
        case 'onPreSync':
        case 'onPostSync':
        default:
          call_user_func($callback, $event['replica']);
          break;
      }
    }
  }
  if (is_array($result)) {
    return $result;
  }
}

/**
 * Implementation of hook_arms_trigger
 */
function yass_arms_trigger() {
  yass_arms_clear();
  
  require_once 'YASS/Engine.php';
  $replicas = YASS_Engine::singleton()->getActiveReplicas();
  
  $result = array();
  foreach ($replicas as $replica) {
    $result = array_merge($result, module_invoke_all('yass_replica', array('replica' => $replica, 'op' => 'createSqlTriggers')));
  }
  return $result;
}

/**
 * hook_service implementation.
 */
function yass_service() {
  return array(
    array(
      '#method' => 'yass.getReplicas',
      '#callback' => 'yass_service_getReplicas',
      '#access callback' => 'user_access',
      '#access arguments' => 'access all replicas',
      '#file' => array('file' => 'service.inc', 'module' => 'yass'),
      '#return' => 'array',
      '#help' => t('Retrieve a list of available replicas'),
    ),
    
    // DataStore methods
    
    array(
      '#method' => 'yass.getEntityTypes',
      '#callback' => 'yass_service_getEntityTypes',
      '#access callback' => 'user_access',
      '#access arguments' => 'access all replicas',
      '#file' => array('file' => 'service.inc', 'module' => 'yass'),
      '#args' => array(
        array(
          '#name' => 'replicaName',
          '#type' => 'string',
          '#description' => t('Name of replica'),
        ),
      ),
      '#return' => 'array',
      '#help' => t('Get supported entity types'),
    ),
    array(
      '#method' => 'yass.getEntities',
      '#callback' => 'yass_service_getEntities',
      '#access callback' => 'user_access',
      '#access arguments' => 'access all replicas',
      '#file' => array('file' => 'service.inc', 'module' => 'yass'),
      '#args' => array(
        array(
          '#name' => 'replicaName',
          '#type' => 'string',
          '#description' => t('Name of replica'),
        ),
        array(
          '#name' => 'entityGuids',
          '#type' => 'array',
          '#description' => t('List of entities to retrieve'),
        ),
      ),
      '#return' => 'array',
      '#help' => t('Retrieve a batch of entities'),
    ),
    array(
      '#method' => 'yass.putEntities',
      '#callback' => 'yass_service_putEntities',
      '#access callback' => 'user_access',
      '#access arguments' => 'access all replicas',
      '#file' => array('file' => 'service.inc', 'module' => 'yass'),
      '#args' => array(
        array(
          '#name' => 'replicaName',
          '#type' => 'string',
          '#description' => t('Name of replica'),
        ),
        array(
          '#name' => 'entities',
          '#type' => 'array',
          '#description' => t('List of entities to save'),
        ),
      ),
      '#return' => 'array',
      '#help' => t('Save a batch of entities'),
    ),
    
    // SyncStore methods
    
    array(
      '#method' => 'yass.validateGuids',
      '#callback' => 'yass_service_validateGuids',
      '#access callback' => 'user_access',
      '#access arguments' => 'access all replicas',
      '#file' => array('file' => 'service.inc', 'module' => 'yass'),
      '#args' => array(
        array(
          '#name' => 'replicaName',
          '#type' => 'string',
          '#description' => t('Name of replica'),
        ),
      ),
      '#return' => 'array',
      '#help' => t('Validate GUIDs'),
    ),
    array(
      '#method' => 'yass.getLastSeenVersions',
      '#callback' => 'yass_service_getLastSeenVersions',
      '#access callback' => 'user_access',
      '#access arguments' => 'access all replicas',
      '#file' => array('file' => 'service.inc', 'module' => 'yass'),
      '#args' => array(
        array(
          '#name' => 'replicaName',
          '#type' => 'string',
          '#description' => t('Name of replica'),
        ),
      ),
      '#return' => 'array',
      '#help' => t('Get list of entity-versions which have been seen [array(replicaId => YASS_Version)]'),
    ),
    array(
      '#method' => 'yass.markSeens',
      '#callback' => 'yass_service_markSeens',
      '#access callback' => 'user_access',
      '#access arguments' => 'access all replicas',
      '#file' => array('file' => 'service.inc', 'module' => 'yass'),
      '#args' => array(
        array(
          '#name' => 'replicaName',
          '#type' => 'string',
          '#description' => t('Name of replica'),
        ),
        array(
          '#name' => 'versions',
          '#type' => 'array',
          '#description' => t('array(YASS_Version)'),
        ),
      ),
      '#return' => 'array',
      '#help' => t('Assert that this replica includes the data for several (replicaId,tick) pairs'),
    ),
    array(
      '#method' => 'yass.getModifieds',
      '#callback' => 'yass_service_getModifieds',
      '#access callback' => 'user_access',
      '#access arguments' => 'access all replicas',
      '#file' => array('file' => 'service.inc', 'module' => 'yass'),
      '#args' => array(
        array(
          '#name' => 'replicaName',
          '#type' => 'string',
          '#description' => t('Name of replica'),
        ),
        array(
          '#name' => 'lastSeenVersions',
          '#type' => 'array',
          '#description' => t('array(replicaId => YASS_Version)'),
        ),
      ),
      '#return' => 'array',
      '#help' => t('Find all records in a replica which have been modified since the given point [array(entityGuid => YASS_SyncState)]'),
    ),
    array(
      '#method' => 'yass.getSyncStates',
      '#callback' => 'yass_service_getSyncStates',
      '#access callback' => 'user_access',
      '#access arguments' => 'access all replicas',
      '#file' => array('file' => 'service.inc', 'module' => 'yass'),
      '#args' => array(
        array(
          '#name' => 'replicaName',
          '#type' => 'string',
          '#description' => t('Name of replica'),
        ),
        array(
          '#name' => 'entityGuids',
          '#type' => 'array',
          '#description' => t('array(entityGuid)'),
        ),
      ),
      '#return' => 'array',
      '#help' => t('Determine the sync state of a particular entity [array(entityGuid => YASS_SyncState)]'),
    ),
    array(
      '#method' => 'yass.setSyncStates',
      '#callback' => 'yass_service_setSyncStates',
      '#access callback' => 'user_access',
      '#access arguments' => 'access all replicas',
      '#file' => array('file' => 'service.inc', 'module' => 'yass'),
      '#args' => array(
        array(
          '#name' => 'replicaName',
          '#type' => 'string',
          '#description' => t('Name of replica'),
        ),
        array(
          '#name' => 'versions',
          '#type' => 'array',
          '#description' => t('array(entityGuid => YASS_Version)'),
        ),
      ),
      '#return' => 'array',
      '#help' => t('Set the sync states of several entities'),
    ),
    array(
      '#method' => 'yass.updateAllVersions',
      '#callback' => 'yass_service_updateAllVersions',
      '#access callback' => 'user_access',
      '#access arguments' => 'access all replicas',
      '#file' => array('file' => 'service.inc', 'module' => 'yass'),
      '#args' => array(
        array(
          '#name' => 'replicaName',
          '#type' => 'string',
          '#description' => t('Name of replica'),
        ),
      ),
      '#return' => 'array',
      '#help' => t('Forcibly increment the versions of entities to make the current replica appear newest'),
    ),
    array(
      '#method' => 'yass.destroy',
      '#callback' => 'yass_service_destroy',
      '#access callback' => 'user_access',
      '#access arguments' => 'access all replicas',
      '#file' => array('file' => 'service.inc', 'module' => 'yass'),
      '#args' => array(
        array(
          '#name' => 'replicaName',
          '#type' => 'string',
          '#description' => t('Name of replica'),
        ),
      ),
      '#return' => 'array',
      '#help' => t('Destroy any last-seen or sync-state data'),
    ),
  );
}
