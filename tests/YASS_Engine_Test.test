<?php

/**
 * Test synchronization service
 * 
 * Dependencies:
 * Drupal-SimpleTest 1.x
 */ 

require_once 'YASS/Test.php';

class YASS_Engine_Test extends YASS_Test {
  function get_info() {
    return array(
      'name' => t('YASS Engine'),
      'desc' => 'Test the high-level engine operations',
      'group' => 'YASS'
    );
  }
  
  function setUp() {
    parent::setUp();
    // module_load_include('inc', 'yass');
    require_once 'YASS/Engine.php';
  }

  function testDestroyOne() {
    $this->_eval('master,r1,r2:init:GenericSQL,GenericSQL *:sync r1:add:a r2:add:b *:sync *:sync r2:modify:a *:sync *:sync');
    $r1 = YASS_Engine::getReplicaByName('r1');
    $r2 = YASS_Engine::getReplicaByName('r2');
    
    $this->assertEqual(2, db_result(db_query('SELECT count(*) FROM {yass_datastore} WHERE replica_id = %d', $r1->id)));
    $this->assertEqual(2, db_result(db_query('SELECT count(*) FROM {yass_datastore} WHERE replica_id = %d', $r2->id)));
    $this->assertEqual(2, db_result(db_query('SELECT count(*) FROM {yass_syncstore_state} WHERE replica_id = %d', $r1->id)));
    $this->assertEqual(2, db_result(db_query('SELECT count(*) FROM {yass_syncstore_state} WHERE replica_id = %d', $r2->id)));
    $this->assertEqual(3, db_result(db_query('SELECT count(*) FROM {yass_syncstore_seen} WHERE replica_id = %d', $r1->id)));
    $this->assertEqual(3, db_result(db_query('SELECT count(*) FROM {yass_syncstore_seen} WHERE replica_id = %d', $r2->id)));
    
    $this->_eval('r2:destroy');
    
    $this->assertEqual(2, db_result(db_query('SELECT count(*) FROM {yass_datastore} WHERE replica_id = %d', $r1->id)));
    $this->assertEqual(0, db_result(db_query('SELECT count(*) FROM {yass_datastore} WHERE replica_id = %d', $r2->id)));
    $this->assertEqual(2, db_result(db_query('SELECT count(*) FROM {yass_syncstore_state} WHERE replica_id = %d', $r1->id)));
    $this->assertEqual(0, db_result(db_query('SELECT count(*) FROM {yass_syncstore_state} WHERE replica_id = %d', $r2->id)));
    $this->assertEqual(3, db_result(db_query('SELECT count(*) FROM {yass_syncstore_seen} WHERE replica_id = %d', $r1->id)));
    $this->assertEqual(0, db_result(db_query('SELECT count(*) FROM {yass_syncstore_seen} WHERE replica_id = %d', $r2->id)));
  }
    
}
