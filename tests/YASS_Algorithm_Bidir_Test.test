<?php

/**
 * Test synchronization service
 * 
 * Dependencies:
 * Drupal-SimpleTest 1.x
 */ 

require_once 'YASS/Test.php';

class YASS_Algorithm_Bidir_Test extends YASS_Test {
  function get_info() {
    return array(
      'name' => t('YASS Bidir Algorithm'),
      'desc' => 'Test the synchronization engine',
      'group' => 'YASS'
    );
  }
  
  function setUp() {
    parent::setUp();
    require_once 'YASS/Engine.php';
  }
  
  function _runBidir(YASS_Replica_Dummy $left, YASS_Replica_Dummy $right, YASS_ConflictResolver $conflictResolver) {
    return YASS_Engine::bidir(
      $left->data, $left->sync,
      $right->data, $right->sync,
      $conflictResolver
    );
  }

  function testNewLeftToRight() {
    $left = new YASS_Replica_Dummy('testNewLeftToRight_Left');
    $right = new YASS_Replica_Dummy('testNewLeftToRight_Right');
    $this->_runBidir($left, $right, new YASS_ConflictResolver_Exception());
    
    $this->assertSyncState($left, 'contact', '1234', FALSE, FALSE, FALSE);
    $this->assertSyncState($right, 'contact', '1234', FALSE, FALSE, FALSE);
    
    $left->set(array(
      array('contact',  '1234', 'one'),
      array('activity', '2345', 'two'),
      array('contact',  '3456', 'three'),
    ));
    $this->assertSyncState($left, 'contact', '1234', 'testNewLeftToRight_Left', '1', 'one');
    $this->assertSyncState($left, 'activity', '2345', 'testNewLeftToRight_Left', '2', 'two');
    $this->assertSyncState($left, 'contact', '3456', 'testNewLeftToRight_Left', '3', 'three');
    $this->assertSyncState($right, 'contact', '1234', FALSE, FALSE, FALSE);
    $this->assertSyncState($right, 'activity', '2345', FALSE, FALSE, FALSE);
    $this->assertSyncState($right, 'contact', '3456', FALSE, FALSE, FALSE);
    
    $this->_runBidir($left, $right, new YASS_ConflictResolver_Exception());
    $this->assertSyncState($left, 'contact', '1234', 'testNewLeftToRight_Left', '1', 'one');
    $this->assertSyncState($left, 'activity', '2345', 'testNewLeftToRight_Left', '2', 'two');
    $this->assertSyncState($left, 'contact', '3456', 'testNewLeftToRight_Left', '3', 'three');
    $this->assertSyncState($right, 'contact', '1234', 'testNewLeftToRight_Left', '1', 'one');
    $this->assertSyncState($right, 'activity', '2345', 'testNewLeftToRight_Left', '2', 'two');
    $this->assertSyncState($right, 'contact', '3456', 'testNewLeftToRight_Left', '3', 'three');
  }

  function testNewBidir() {
    $left = new YASS_Replica_Dummy('testNewBidir_Left');
    $right = new YASS_Replica_Dummy('testNewBidir_Right');
    $this->_runBidir($left, $right, new YASS_ConflictResolver_Exception());
    
    $this->assertSyncState($right, 'contact', '1234', FALSE, FALSE, FALSE);
    $this->assertSyncState($left, 'contact', '1234', FALSE, FALSE, FALSE);
    
    $left->set(array(
      array('contact',  '1234', 'one'),
      array('activity', '2345', 'two'),
    ));
    $right->set(array(
      array('contact',  '3456', 'three'),
    ));
    $this->assertSyncState($left, 'contact', '1234', 'testNewBidir_Left', '1', 'one');
    $this->assertSyncState($left, 'activity', '2345', 'testNewBidir_Left', '2', 'two');
    $this->assertSyncState($left, 'contact', '3456', FALSE, FALSE, FALSE);
    $this->assertSyncState($right, 'contact', '1234', FALSE, FALSE, FALSE);
    $this->assertSyncState($right, 'activity', '2345', FALSE, FALSE, FALSE);
    $this->assertSyncState($right, 'contact', '3456', 'testNewBidir_Right', '1', 'three');
    
    $this->_runBidir($left, $right, new YASS_ConflictResolver_Exception());
    $this->assertSyncState($left, 'contact', '1234', 'testNewBidir_Left', '1', 'one');
    $this->assertSyncState($left, 'activity', '2345', 'testNewBidir_Left', '2', 'two');
    $this->assertSyncState($left, 'contact', '3456', 'testNewBidir_Right', '1', 'three');
    $this->assertSyncState($right, 'contact', '1234', 'testNewBidir_Left', '1', 'one');
    $this->assertSyncState($right, 'activity', '2345', 'testNewBidir_Left', '2', 'two');
    $this->assertSyncState($right, 'contact', '3456', 'testNewBidir_Right', '1', 'three');
  }
  
  function testConflictSrcWins() {
    $left = new YASS_Replica_Dummy('testConflictSrcWins_Left');
    $right = new YASS_Replica_Dummy('testConflictSrcWins_Right');
    
    $left->set(array(
      array('contact',  '1234', 'one'),
      array('activity', '2345', 'two'),
      array('contact',  '3456', 'three'),
    ));
    $this->_runBidir($left, $right, new YASS_ConflictResolver_Exception());
    $this->assertSyncState($left, 'contact', '1234', 'testConflictSrcWins_Left', '1', 'one');
    $this->assertSyncState($left, 'activity', '2345', 'testConflictSrcWins_Left', '2', 'two');
    $this->assertSyncState($left, 'contact', '3456', 'testConflictSrcWins_Left', '3', 'three');
    $this->assertSyncState($right, 'contact', '1234', 'testConflictSrcWins_Left', '1', 'one');
    $this->assertSyncState($right, 'activity', '2345', 'testConflictSrcWins_Left', '2', 'two');
    $this->assertSyncState($right, 'contact', '3456', 'testConflictSrcWins_Left', '3', 'three');
    
    $left->set(array(
      array('activity', '2345', 'two and a half'),
    ));
    $right->set(array(
      array('activity', '2345', 'two point five'),
    ));
    $this->assertSyncState($left, 'contact', '1234', 'testConflictSrcWins_Left', '1', 'one');
    $this->assertSyncState($left, 'activity', '2345', 'testConflictSrcWins_Left', '4', 'two and a half');
    $this->assertSyncState($left, 'contact', '3456', 'testConflictSrcWins_Left', '3', 'three');
    $this->assertSyncState($right, 'contact', '1234', 'testConflictSrcWins_Left', '1', 'one');
    $this->assertSyncState($right, 'activity', '2345', 'testConflictSrcWins_Right', '1', 'two point five');
    $this->assertSyncState($right, 'contact', '3456', 'testConflictSrcWins_Left', '3', 'three');
    
    $this->_runBidir($left, $right, new YASS_ConflictResolver_SrcWins());
    $this->assertSyncState($left, 'contact', '1234', 'testConflictSrcWins_Left', '1', 'one');
    $this->assertSyncState($left, 'activity', '2345', 'testConflictSrcWins_Left', '4', 'two and a half');
    $this->assertSyncState($left, 'contact', '3456', 'testConflictSrcWins_Left', '3', 'three');
    $this->assertSyncState($right, 'contact', '1234', 'testConflictSrcWins_Left', '1', 'one');
    $this->assertSyncState($right, 'activity', '2345', 'testConflictSrcWins_Left', '4', 'two and a half');
    $this->assertSyncState($right, 'contact', '3456', 'testConflictSrcWins_Left', '3', 'three');
  }

  function testLaggyThreeWayConflict() {
    $rabbit = new YASS_Replica_Dummy('testLaggyThreeWay_Rabbit');
    $monkey = new YASS_Replica_Dummy('testLaggyThreeWay_Monkey');
    $turtle = new YASS_Replica_Dummy('testLaggyThreeWay_Turtle');

    // rabbit => monkey, turtle
    $rabbit->set(array(
      array('contact',  '1234', 'aaa'),
    ));
    $this->_runBidir($rabbit, $monkey, new YASS_ConflictResolver_Exception());
    $this->_runBidir($rabbit, $turtle, new YASS_ConflictResolver_Exception());
    $this->assertSyncState($rabbit, 'contact', '1234', 'testLaggyThreeWay_Rabbit', '1', 'aaa');
    $this->assertSyncState($monkey, 'contact', '1234', 'testLaggyThreeWay_Rabbit', '1', 'aaa');
    $this->assertSyncState($turtle, 'contact', '1234', 'testLaggyThreeWay_Rabbit', '1', 'aaa');
    
    // rabbit => monkey; !turtle
    $rabbit->set(array(
      array('contact',  '1234', 'aaabbb'),
    ));
    $this->_runBidir($rabbit, $monkey, new YASS_ConflictResolver_Exception());
    $this->assertSyncState($rabbit, 'contact', '1234', 'testLaggyThreeWay_Rabbit', '2', 'aaabbb');
    $this->assertSyncState($monkey, 'contact', '1234', 'testLaggyThreeWay_Rabbit', '2', 'aaabbb');
    $this->assertSyncState($turtle, 'contact', '1234', 'testLaggyThreeWay_Rabbit', '1', 'aaa');

    // monkey => turtle, !rabbit
    $monkey->set(array(
      array('contact',  '1234', 'aaabbbccc'),
    ));
    $this->_runBidir($monkey, $turtle, new YASS_ConflictResolver_Exception());
    $this->assertSyncState($rabbit, 'contact', '1234', 'testLaggyThreeWay_Rabbit', '2', 'aaabbb');
    $this->assertSyncState($monkey, 'contact', '1234', 'testLaggyThreeWay_Monkey', '1', 'aaabbbccc');
    $this->assertSyncState($turtle, 'contact', '1234', 'testLaggyThreeWay_Monkey', '1', 'aaabbbccc');

    // rabbit => turtle, !monkey
    $rabbit->set(array(
      array('contact',  '1234', 'aaabbbcccddd'),
    ));
    try {
      $this->_runBidir($rabbit, $turtle, new YASS_ConflictResolver_Exception());
      $this->fail('Expected conflict');
    } catch (Exception $e) {
      // $this->assertSyncState($rabbit, 'contact', '1234', 'testLaggyThreeWay_Rabbit',    '3', 'aaabbbcccddd');
      // $this->assertSyncState($monkey, 'contact', '1234', 'testLaggyThreeWay_Monkey',    '1', 'aaabbbccc');
      // $this->assertSyncState($turtle, 'contact', '1234', 'testLaggyThreeWay_Rabbit',    '3', 'aaabbbcccddd');
    }
  }
  
  function testSentences() {
    $this->_runSentence('r1:add:a r1:sync r2:sync r1:modify:a r2:modify:a r1:modify:a r2:modify:a r1:sync r2:sync:SrcWins',	array('a'=>'a.2 from r2'));
    $this->_runSentence('r1:add:a r1:sync r2:sync r3:sync r2:modify:a r3:modify:a r3:sync r2:sync:SrcWins r1:sync',		array('a'=>'a.1 from r2'));
    $this->_runSentence('r1:add:a r1:sync r2:sync r3:sync r2:modify:a r3:modify:a r3:sync r2:sync:DstWins r1:sync',		array('a'=>'a.1 from r3'));
    $this->_runSentence('r1:add:a r1:sync r2:sync r1:sync r1:modify:a r1:sync r2:modify:a r1:sync r2:sync:SrcWins',		array('a'=>'a.1 from r2'));
    $this->_runSentence('r1:add:a r1:sync r2:sync r1:sync r1:modify:a r1:sync r2:modify:a r1:sync r2:sync:DstWins',		array('a'=>'a.2 from r1'));
    $this->_runSentence('r1:add:a r1:sync r1:modify:a r2:sync r1:sync r2:sync r2:modify:a r2:sync r1:sync',			array('a'=>'a.1 from r2'));
    $this->_runSentence('r1:add:a r1:sync r1:modify:a r2:sync r2:modify:a r1:sync r2:modify:a r2:sync:SrcWins r1:sync',		array('a'=>'a.2 from r2'));
    
    $this->_runSentence('r1:add:a r1:sync r2:sync r1:modify:a r2:add:b r1:modify:a', array('a'=>'a.3 from r1', 'b' => 'b.1 from r2'));
  }
  
  /**
   * Run a series of update and sync operations with a single test entity.
   *
   * @param $sentence a list of space-delimited tasks; valid tasks are:
   *   - "$REPLICA:add:$ENTITY": add a new entity on the replica
   *   - "$REPLICA:modify:$ENTITY": modify the content of the entity on the replica
   *   - "$REPLICA:sync": sync the replica with the master; if a conflict arises, throw an exception
   *   - "$REPLICA:sync:SrcWins": sync the replica with the master; a conflict is expected and will be resolved with SrcWins
   * @param $convergentValues array (entityGuid=>string), the final values to which all replicas converge after evaluating the sentence
   */
  function _runSentence($sentence, $convergentValues) {
    // consistent starting point
    $replicas = array(
      'master' => new YASS_Replica_Dummy('master'),
      'r1' => new YASS_Replica_Dummy('r1'),
      'r2' => new YASS_Replica_Dummy('r2'),
      'r3' => new YASS_Replica_Dummy('r3'),
    );
    foreach ($replicas as $replicaId => $replica) {
      if ($replicaId == 'master') continue;
      $this->_runBidir($replicas[$replicaId], $replicas['master'], new YASS_ConflictResolver_Exception());
    }
  
    // go!
    $entityType = 'testentity';
    $updates = array(); // array(entityGuid => array(replicaId => int))
    foreach (explode(' ', $sentence) as $task) {
      list ($replicaId,$action,$opt) = explode(':', $task);
      switch ($action) {
        case 'add':
          $updates[$opt][$replicaId] = 1;
          $replicas[$replicaId]->set(array(
            array($entityType, $opt, sprintf('%s.%d from %s', $opt, $updates[$opt][$replicaId], $replicaId)),
          ));
          break;
        case 'modify':
          $updates[$opt][$replicaId] = 1+(empty($updates[$opt][$replicaId]) ? 0 : $updates[$opt][$replicaId]);
          $replicas[$replicaId]->set(array(
            array($entityType, $opt, sprintf('%s.%d from %s', $opt, $updates[$opt][$replicaId], $replicaId)),
          ));
          break;
        case 'sync':
          if (empty($opt)) {
            $conflictResolver = new YASS_ConflictResolver_Exception();
            $this->_runBidir($replicas[$replicaId], $replicas['master'], $conflictResolver);
          } else {
            $class = new ReflectionClass('YASS_ConflictResolver_' . $opt);
            $conflictResolver = new YASS_ConflictResolver_Queue(array($class->newInstance()));
            $this->_runBidir($replicas[$replicaId], $replicas['master'], $conflictResolver);
            $this->assertTrue($conflictResolver->isEmpty(), 'A conflict resolver was specified but no conflict arose');
          }
          break;
        default:
          $this->fail('Unrecognized task: ' . $task);
      }
    }
    
    // converge to a consistent ending point
    foreach ($replicas as $replicaId => $replica) {
      if ($replicaId == 'master') continue;
      $this->_runBidir($replicas[$replicaId], $replicas['master'], new YASS_ConflictResolver_Exception());
    }
    foreach ($replicas as $replicaId => $replica) {
      if ($replicaId == 'master') continue;
      $this->_runBidir($replicas[$replicaId], $replicas['master'], new YASS_ConflictResolver_Exception());
    }
    
    // printf("SENTENCE: %s\n", $sentence);
    // $this->dumpReplicas($replicas);
    
    foreach ($replicas as $replicaId => $replica) {
      foreach ($convergentValues as $entityGuid => $convergentValue) {
        list ($actualReplicaId, $actualTick, $actualData) = $replica->get($entityType, $entityGuid);
        $this->assertEqual($convergentValue, $actualData);
      }
    }
  }
}
